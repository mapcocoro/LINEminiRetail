// Boulangerie SOLEIL - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ユーザー（LINEログイン連携）
model User {
  id            String   @id @default(cuid())
  lineUserId    String   @unique
  displayName   String?
  pictureUrl    String?
  totalPoints   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  reservations  Reservation[]
  orders        Order[]
  pointHistory  PointHistory[]
  coupons       UserCoupon[]
  purchaseHistory PurchaseHistory[]
}

// 商品カテゴリ
model Category {
  id          String    @id @default(cuid())
  name        String    // 食パン、菓子パン、惣菜パン、ハード系など
  slug        String    @unique
  displayOrder Int      @default(0)
  imageUrl    String?
  createdAt   DateTime  @default(now())

  products    Product[]
}

// 商品
model Product {
  id            String   @id @default(cuid())
  name          String
  description   String?
  price         Int
  imageUrl      String?
  categoryId    String
  stock         Int      @default(0)
  maxReserveQty Int      @default(5) // 取り置き上限
  isNew         Boolean  @default(false)
  isPopular     Boolean  @default(false)
  isActive      Boolean  @default(true)
  allergens     String?  // 小麦, 卵, 乳 等
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category      Category @relation(fields: [categoryId], references: [id])
  reservationItems ReservationItem[]
  orderItems    OrderItem[]
  purchaseHistory PurchaseHistory[]
}

// 取り置き予約
model Reservation {
  id            String   @id @default(cuid())
  userId        String
  pickupDate    DateTime
  pickupTimeSlot String  // "10:00-12:00" など
  status        String   @default("pending") // pending, confirmed, completed, cancelled
  totalAmount   Int
  note          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])
  items         ReservationItem[]
}

model ReservationItem {
  id            String   @id @default(cuid())
  reservationId String
  productId     String
  quantity      Int
  price         Int

  reservation   Reservation @relation(fields: [reservationId], references: [id])
  product       Product     @relation(fields: [productId], references: [id])
}

// 注文（オンライン決済用）
model Order {
  id            String   @id @default(cuid())
  userId        String
  orderNumber   String   @unique
  status        String   @default("pending") // pending, paid, preparing, ready, completed, cancelled
  deliveryType  String   // pickup, delivery
  totalAmount   Int
  paymentMethod String?  // line_pay, credit_card
  paymentStatus String   @default("unpaid") // unpaid, paid, refunded
  pickupDate    DateTime?
  pickupTimeSlot String?
  shippingAddress String?
  note          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])
  items         OrderItem[]
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Int

  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

// ポイント履歴
model PointHistory {
  id          String   @id @default(cuid())
  userId      String
  points      Int      // + or -
  type        String   // earned, used, expired, bonus
  description String?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
}

// クーポン定義
model Coupon {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  description   String?
  discountType  String   // percentage, fixed
  discountValue Int      // 10% or 100円
  minPurchase   Int?     // 最低購入金額
  maxUses       Int?     // 全体の使用上限
  usedCount     Int      @default(0)
  validFrom     DateTime
  validUntil    DateTime
  conditions    String?  // rain, first_visit, birthday など
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  userCoupons   UserCoupon[]
}

// ユーザー保有クーポン
model UserCoupon {
  id        String   @id @default(cuid())
  userId    String
  couponId  String
  isUsed    Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user      User   @relation(fields: [userId], references: [id])
  coupon    Coupon @relation(fields: [couponId], references: [id])
}

// 営業日カレンダー
model BusinessDay {
  id          String   @id @default(cuid())
  date        DateTime @unique
  isOpen      Boolean  @default(true)
  openTime    String?  // "09:00"
  closeTime   String?  // "18:00"
  note        String?  // "臨時休業" など
  createdAt   DateTime @default(now())
}

// 定休日設定
model RegularHoliday {
  id        String @id @default(cuid())
  dayOfWeek Int    // 0=日曜, 1=月曜 ...
}

// 購入履歴（レコメンド用）
model PurchaseHistory {
  id        String   @id @default(cuid())
  userId    String
  productId String
  quantity  Int
  purchasedAt DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

// 定期購入
model Subscription {
  id            String   @id @default(cuid())
  userId        String
  planName      String   // パンの詰め合わせ週1回など
  frequency     String   // weekly, biweekly, monthly
  amount        Int
  status        String   @default("active") // active, paused, cancelled
  nextDelivery  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
